version: '3.8'

services:
  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ (ë¡œì»¬ ê°œë°œìš©)
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: nexus_api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # ë¡œì»¬ DB ì—°ê²° ì£¼ì†Œ (ê¸°ë³¸ê°’ ì„¤ì •. .env íŒŒì¼ì˜ ê°’ì„ ìš°ì„  ì°¸ì¡°í•¨)
      - DATABASE_URL=${DATABASE_URL:-postgresql+asyncpg://nexus_user:nexus_pass@db:5432/nexus_core}
    env_file:
      - ./backend/.env
    depends_on:
      - db
    volumes:
      # í˜¸ìŠ¤íŠ¸ì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸ (í•« ë¦¬ë¡œë“œìš©)
      - ./backend:/app
      # ë„ì»¤ ì´ë¯¸ì§€ê°€ ë¹Œë“œí•´ë‘” ë¦¬ëˆ…ìŠ¤ìš© .venv í™˜ê²½ì´ í˜¸ìŠ¤íŠ¸ íŒŒì¼ì— ì˜í•´ ë®ì–´ì”Œì›Œì§€ì§€ ì•Šë„ë¡ ë³´í˜¸
      - /app/.venv
    # ê°€ìƒí™˜ê²½ì´ ë³´í˜¸ë˜ì—ˆìœ¼ë¯€ë¡œ ë‚´ë¶€ uvicorn ëª…ë ¹ì–´ë¡œ ì‹¤í–‰ ê°€ëŠ¥
    command: uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload

  # ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤
  db:
    image: postgres:15-alpine
    container_name: nexus_db
    restart: always
    ports:
      - "5432:5432"
    environment:
      # ë¡œì»¬ ì „ìš© ê°€ì§œ DB ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ì„ ìœ„í•œ ì´ˆê¸°ê°’ (ë³´ì•ˆê³¼ ë¬´ê´€í•˜ë¯€ë¡œ í•˜ë“œì½”ë”©)
      - POSTGRES_USER=nexus_user
      - POSTGRES_PASSWORD=nexus_pass
      - POSTGRES_DB=nexus_core
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # ìµœì´ˆ êµ¬ë™ ì‹œ ìŠ¤í‚¤ë§ˆ ìë™ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - ./backend/scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql

  # ğŸŸ¢ Next.js ì¼ë°˜ ì‚¬ìš©ì ì›¹ ì„œë¹„ìŠ¤ (Nexus Portal)
  client:
    build:
      context: ./frontend-client
      dockerfile: Dockerfile
    container_name: nexus_client
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Next.js ì•±ì—ì„œ ë°±ì—”ë“œ API ì„œë²„ë¥¼ í˜¸ì¶œí•  ì£¼ì†Œ (ì›¹ ë¸Œë¼ìš°ì € ê¸°ì¤€)
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
    depends_on:
      - api
    volumes:
      # í˜¸ìŠ¤íŠ¸ì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸ (Next.js í•« ë¦¬ë¡œë“œ)
      - ./frontend-client:/app
      - /app/node_modules
      - /app/.next

  # ğŸ”´ Next.js ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ
  admin:
    build:
      context: ./frontend-admin
      dockerfile: Dockerfile
    container_name: nexus_admin
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
    depends_on:
      - api
    volumes:
      - ./frontend-admin:/app
      - /app/node_modules
      - /app/.next

volumes:
  postgres_data: