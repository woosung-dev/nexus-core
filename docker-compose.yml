version: '3.8'

services:
  # 애플리케이션 서버 (로컬 개발용)
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: nexus_api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # 로컬 DB 연결 주소 (기본값 설정. .env 파일의 값을 우선 참조함)
      - DATABASE_URL=${DATABASE_URL:-postgresql+asyncpg://nexus_user:nexus_pass@db:5432/nexus_core}
    env_file:
      - ./backend/.env
    depends_on:
      - db
    volumes:
      # 호스트의 소스코드를 컨테이너에 마운트 (핫 리로드용)
      - ./backend:/app
      # 도커 이미지가 빌드해둔 리눅스용 .venv 환경이 호스트 파일에 의해 덮어씌워지지 않도록 보호
      - /app/.venv
    # 가상환경이 보호되었으므로 내부 uvicorn 명령어로 실행 가능
    command: uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload

  # 로컬 데이터베이스
  db:
    image: postgres:15-alpine
    container_name: nexus_db
    restart: always
    ports:
      - "5432:5432"
    environment:
      # 로컬 전용 가짜 DB 인스턴스 생성을 위한 초기값 (보안과 무관하므로 하드코딩)
      - POSTGRES_USER=nexus_user
      - POSTGRES_PASSWORD=nexus_pass
      - POSTGRES_DB=nexus_core
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # 최초 구동 시 스키마 자동 생성 스크립트 실행
      - ./backend/scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql

volumes:
  postgres_data: